<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{block "head" .}}
    <title>{{ .Site.Title }}</title>
    {{end}}

    <link rel="stylesheet" href="/assets/main.css">
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logowrap">
                    <a class="logo" href="/">{{ .Site.Title }}</a>
                </div>
                <nav class="site-navbar">
                    <ul>
                        <li>
                            <a href="/" class="{{ if eq .CurrentPath "/" }}active{{ end }}">首页</a>
                        </li>
                        <li>
                            <a href="/search" class="{{ if eq .CurrentPath "/search" }}active{{ end }}">查询</a>
                        </li>
                        <li>
                            <a href="/tag" class="{{ if eq .CurrentPath "/tag" }}active{{ end }}">标签</a>
                        </li>
                        <!-- <li>
                            <a href="/archive">归档</a>
                        </li> -->
                        {{- if not .Auth.IsLogin -}}
                        <li>
                            <a href="/auth" class="{{ if eq .CurrentPath "/auth" }}active{{ end }}">登录</a>
                        </li>
                        {{- else -}}
                        <li>
                            <a href="/gitpull" class="{{ if eq .CurrentPath "/gitpull" }}active{{ end }}">git pull</a>
                        </li>
                        {{- end -}}
                    </ul>
                </nav>
            </div>
        </header>

        <main class="content">
            {{block "content" .}}
            {{end}}
        </main>

        <footer>
            <p>
                Powered by <a href="https://github.com/MACDfree/obsidian-web" target="_blank">obsidian-web</a> | <a href="https://github.com/MACDfree" target="_blank">GitHub</a> | <a href="mailto:macdfree@163.com">Email</a>
            </p>
        </footer>
    </div>

    <!-- 图片查看器 -->
    <div id="image-viewer" class="image-viewer">
        <div class="image-viewer-content">
            <span class="image-viewer-close">&times;</span>
            <img id="viewer-image" class="viewer-image" src="" alt="放大图片">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取图片查看器元素
            const imageViewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            const closeBtn = document.querySelector('.image-viewer-close');
            
            // 为所有图片添加点击事件
            function addImageClickListeners() {
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    // 避免重复添加事件
                    if (!img.hasAttribute('data-image-viewer')) {
                        img.setAttribute('data-image-viewer', 'true');
                        img.addEventListener('click', function(e) {
                            // 阻止事件冒泡，避免触发其他点击事件
                            e.stopPropagation();
                            
                            // 设置查看器图片源
                            viewerImage.src = this.src;
                            
                            // 显示查看器
                            imageViewer.style.display = 'flex';
                            
                            // 添加缩放初始化
                            viewerImage.style.transform = 'scale(1)';
                            viewerImage.style.transition = 'transform 0.3s ease';
                            
                            // 禁止页面滚动
                            document.body.style.overflow = 'hidden';
                        });
                    }
                });
            }
            
            // 初始添加事件监听器
            addImageClickListeners();
            
            // 监听DOM变化，为动态加载的图片添加事件
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        addImageClickListeners();
                        addCopyButtons();
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // 关闭查看器
            function closeViewer() {
                imageViewer.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // 点击关闭按钮
            closeBtn.addEventListener('click', closeViewer);
            
            // 点击查看器背景关闭
            imageViewer.addEventListener('click', function(e) {
                if (e.target === imageViewer) {
                    closeViewer();
                }
            });
            
            // 按ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && imageViewer.style.display === 'flex') {
                    closeViewer();
                }
            });
            
            // 实现图片缩放
            let scale = 1;
            const scaleStep = 0.1;
            const minScale = 0.1;
            const maxScale = 5;
            
            viewerImage.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                // 计算缩放方向
                const delta = e.deltaY > 0 ? -scaleStep : scaleStep;
                scale = Math.max(minScale, Math.min(maxScale, scale + delta));
                
                // 应用缩放
                viewerImage.style.transform = `scale(${scale})`;
            });
            
            // 支持触摸设备的缩放
            let touchStartDistance = 0;
            let touchStartScale = 1;
            
            viewerImage.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    touchStartDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    touchStartScale = scale;
                }
            });
            
            viewerImage.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const touchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    const newScale = touchStartScale * (touchDistance / touchStartDistance);
                    scale = Math.max(minScale, Math.min(maxScale, newScale));
                    
                    viewerImage.style.transform = `scale(${scale})`;
                }
            });
            
            // 为代码块添加复制按钮
            function addCopyButtons() {
                // 只选择顶层的chroma元素，避免嵌套导致重复添加
                const codeBlocks = document.querySelectorAll('.content > article div.chroma');
                codeBlocks.forEach(block => {
                    // 避免重复添加按钮
                    if (!block.parentNode.classList.contains('code-block-container')) {
                        // 创建外层容器
                        const container = document.createElement('div');
                        container.className = 'code-block-container';
                        
                        // 将chroma元素移动到容器中
                        block.parentNode.insertBefore(container, block);
                        container.appendChild(block);
                        
                        // 创建复制按钮
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'code-copy-btn';
                        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> 复制';
                        
                        copyBtn.addEventListener('click', function() {
                            // 获取代码内容，排除行号
                            let codeContent = '';
                            const table = block.querySelector('table.lntable');
                            
                            if (table) {
                                // 如果是带有行号的代码块
                                const rows = table.querySelectorAll('tr');
                                rows.forEach(row => {
                                    const codeCell = row.querySelector('td:last-child');
                                    if (codeCell) {
                                        // 提取代码行文本，排除行号
                                        const codeLine = codeCell.textContent.trim();
                                        codeContent += codeLine + '\n';
                                    }
                                });
                            } else {
                                // 如果是没有行号的代码块
                                codeContent = block.textContent;
                            }
                            
                            // 去除最后一个多余的换行符
                            codeContent = codeContent.trimEnd();
                            
                            // 使用Clipboard API复制内容
                            navigator.clipboard.writeText(codeContent).then(() => {
                                // 显示复制成功状态
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> 已复制';
                                copyBtn.classList.add('copied');
                                
                                // 恢复原始状态
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('copied');
                                }, 2000);
                            }).catch(err => {
                                console.error('复制失败:', err);
                            });
                        });
                        
                        // 将复制按钮添加到容器中
                        container.appendChild(copyBtn);
                    }
                });
            }
            
            // 初始添加复制按钮
            addCopyButtons();
        });
    </script>

</body>

</html>